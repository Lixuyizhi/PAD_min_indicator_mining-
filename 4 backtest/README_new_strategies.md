# 新策略说明

本项目已更新为三个新的交易策略，替换了原有的情绪指标策略。同时实现了模块化设计，将可视化功能解耦到独立的分析模块中。

## 策略概览

### 1. 布林带策略 (BollingerBandsStrategy)

**策略原理：**
- 基于布林带技术指标进行交易
- 当价格触及布林带下轨时买入
- 当价格触及布林带上轨或回到中轨时卖出
- 包含止损和止盈机制

**主要参数：**
- `bb_period`: 布林带周期 (默认: 20)
- `bb_dev`: 布林带标准差倍数 (默认: 2.0)
- `position_size`: 仓位大小 (默认: 0.1)
- `stop_loss`: 止损比例 (默认: 0.02)
- `take_profit`: 止盈比例 (默认: 0.04)

**交易逻辑：**
- 买入条件：价格 ≤ 布林带下轨
- 卖出条件：
  - 止损：价格 < 买入价格 × (1 - 止损比例)
  - 止盈：价格 > 买入价格 × (1 + 止盈比例)
  - 布林带卖出：价格 ≥ 布林带上轨
  - 中轨卖出：价格 ≥ 布林带中轨 × 0.99

### 2. 海龟交易策略 (TurtleTradingStrategy)

**策略原理：**
- 基于经典的海龟交易系统
- 突破20日高点时买入
- 突破10日低点时卖出
- 使用ATR进行动态止损

**主要参数：**
- `entry_period`: 入场突破周期 (默认: 20)
- `exit_period`: 出场突破周期 (默认: 10)
- `atr_period`: ATR周期 (默认: 20)
- `position_size`: 仓位大小 (默认: 0.1)
- `risk_percent`: 风险百分比 (默认: 0.02)

**交易逻辑：**
- 买入条件：当前最高价 > 20日最高价
- 卖出条件：
  - 海龟出场：当前最低价 < 10日最低价
  - ATR止损：价格 < 买入价格 - 2 × ATR

### 3. 信号量等级反向策略 (SignalLevelReverseStrategy)

**策略原理：**
- 基于IC检验结果：信号量等级和5期收益率成反比
- 当信号量等级高时买入（预期未来收益率会下降）
- 当信号量等级降低或5期收益率为负时卖出

**主要参数：**
- `signal_level_threshold`: 信号量等级阈值 (默认: 6)
- `position_size`: 仓位大小 (默认: 0.1)
- `stop_loss`: 止损比例 (默认: 0.02)
- `take_profit`: 止盈比例 (默认: 0.04)
- `lookback_period`: 回看期数 (默认: 5)

**交易逻辑：**
- 买入条件：信号量等级 ≥ 阈值
- 卖出条件：
  - 止损：价格 < 买入价格 × (1 - 止损比例)
  - 止盈：价格 > 买入价格 × (1 + 止盈比例)
  - 信号量等级降低：当前等级 < 阈值 × 0.8
  - 5期收益率反转：5期收益率 < -0.01

## 模块化架构

### 核心模块

1. **`emotion_strategy.py`** - 策略实现模块
   - 包含三个交易策略的实现
   - 每个策略都包含资金跟踪功能

2. **`backtest_engine.py`** - 回测引擎模块
   - 负责运行回测的核心逻辑
   - 集成了分析模块，但保持简洁

3. **`analyst.py`** - 分析可视化模块（新增）
   - `BacktestVisualizer`: 负责绘制回测结果图表
   - `BacktestAnalyzer`: 负责分析策略性能
   - `create_comparison_chart`: 创建策略对比图表

4. **`main.py`** - 主程序模块
   - 提供用户界面和配置
   - 集成所有模块功能

5. **`optimizer.py`** - 参数优化模块
   - 支持三个策略的参数优化

### 模块解耦优势

- **职责分离**: 每个模块专注于特定功能
- **易于维护**: 修改可视化功能不影响回测逻辑
- **可扩展性**: 可以轻松添加新的分析功能
- **代码复用**: 分析模块可以被其他项目复用

## 新的可视化功能

### 可视化布局
新的可视化系统包含5个子图：

1. **K线图和策略指标** (左上，占2行)
   - 显示价格K线图
   - 叠加策略相关指标（布林带、海龟指标等）
   - 显示交易统计信息

2. **资金曲线** (左中，占1行)
   - 显示总资产变化
   - 包含收益率信息
   - 基准线显示初始资金

3. **策略指标** (左下，占1行)
   - 显示策略使用的技术指标
   - 不同策略显示不同指标

4. **回撤曲线** (左底，占1行)
   - 显示回撤变化
   - 标注最大回撤

5. **统计信息** (右侧，占全部高度)
   - 显示详细的回测统计结果
   - 包含收益率、夏普比率、最大回撤等

### 可视化改进

1. **数据采样**：当数据点过多时自动采样，避免图表过于密集
2. **资金跟踪**：实时记录总资产变化，提供准确的资金曲线
3. **回撤计算**：基于实际资金数据计算回撤，更加准确
4. **统计信息**：在图表中直接显示关键统计指标
5. **策略指标**：在K线图上叠加策略指标，便于分析

### 可视化特点

- **清晰布局**：使用网格布局，合理分配空间
- **信息丰富**：同时显示价格、指标、资金、回撤和统计信息
- **易于理解**：使用颜色和标签区分不同信息
- **性能优化**：大数据量时自动采样，保证显示效果

## 使用方法

### 运行单个策略回测

```python
# 在main.py中修改配置
STRATEGY_TYPE = "bollinger_bands"  # 可选: "bollinger_bands", "turtle_trading", "signal_level_reverse"
RUN_MODE = "backtest"
SHOW_PLOT = True  # 设置为True显示图表

# 运行
python main.py
```

### 运行策略对比

```python
# 在main.py中修改配置
RUN_MODE = "compare"

# 运行
python main.py
```

### 运行参数优化

```python
# 在main.py中修改配置
RUN_MODE = "optimize"
STRATEGY_TYPE = "bollinger_bands"  # 选择要优化的策略

# 运行
python main.py
```

### 测试分析模块

```python
# 运行分析模块测试脚本
python test_analyst.py
```

## 文件结构

- `emotion_strategy.py`: 包含三个新策略的实现
- `backtest_engine.py`: 回测引擎，负责核心回测逻辑
- `analyst.py`: 分析可视化模块（新增）
  - `BacktestVisualizer`: 可视化器
  - `BacktestAnalyzer`: 分析器
  - `create_comparison_chart`: 对比图表函数
- `main.py`: 主程序，支持回测、优化、对比功能
- `optimizer.py`: 参数优化器，支持三个策略的参数优化
- `test_analyst.py`: 分析模块测试脚本（新增）
- `data_loader.py`: 数据加载器

## 注意事项

1. 确保数据文件包含必要的列：
   - 对于信号量等级反向策略，需要包含 `信号量_等级` 列
   - 其他策略只需要标准的OHLCV数据

2. 策略参数可以根据实际情况进行调整

3. 建议在实盘交易前进行充分的回测验证

4. 所有策略都包含风险控制机制（止损、止盈）

5. 新的可视化系统会自动处理大数据量，提供清晰的可视化效果

6. 图表会自动保存到 `backtest_results` 目录中

7. 模块化设计使得代码更易于维护和扩展 